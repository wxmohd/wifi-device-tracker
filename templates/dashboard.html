<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Fi Device Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <meta http-equiv="refresh" content="300"> <!-- Auto-refresh every 5 minutes -->
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <div class="brand-icon">
                    <i class="fas fa-wifi"></i>
                </div>
                <span class="brand-text">Wi-Fi Tracker</span>
            </a>
            <div class="navbar-actions ms-auto d-flex align-items-center">
                <span class="badge security-badge me-3">
                    <i class="fas fa-shield-alt me-1"></i> Security Monitor
                </span>
                <button id="theme-toggle" class="theme-toggle" aria-label="Toggle dark/light mode">
                    <i class="fas fa-moon"></i>
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="app-container">
        <div class="py-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show custom-alert" role="alert">
                            <div class="alert-icon"><i class="fas fa-info-circle"></i></div>
                            <div class="alert-content">{{ message }}</div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

        <div class="dashboard-grid mb-4">
            <div class="dashboard-card network-status-card">
                <div class="card-header">
                    <div class="header-icon">
                        <i class="fas fa-signal-stream"></i>
                    </div>
                    <h5>Network Status</h5>
                </div>
                <div class="card-body">
                    <div class="status-grid">
                        <div class="status-item">
                            <div class="status-icon"><i class="fas fa-network-wired"></i></div>
                            <div class="status-details">
                                <div class="status-label">Local IP</div>
                                <div class="status-value">{{ local_ip }}</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon"><i class="fas fa-project-diagram"></i></div>
                            <div class="status-details">
                                <div class="status-label">Subnet</div>
                                <div class="status-value">{{ subnet }}</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon"><i class="fas fa-clock"></i></div>
                            <div class="status-details">
                                <div class="status-label">Last Scan</div>
                                <div class="status-value">{{ last_scan_time }}</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon"><i class="fas fa-laptop-house"></i></div>
                            <div class="status-details">
                                <div class="status-label">Devices Found</div>
                                <div class="status-value">{{ devices|length }}</div>
                            </div>
                        </div>
                        <div class="status-item">
                            <div class="status-icon">
                                <i class="fas fa-shield-virus {% if untrusted_count > 0 %}text-danger{% else %}text-success{% endif %}"></i>
                            </div>
                            <div class="status-details">
                                <div class="status-label">Untrusted Devices</div>
                                <div class="status-value {% if untrusted_count > 0 %}text-danger{% else %}text-success{% endif %}">
                                    {{ untrusted_count }}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="scan-controls" class="mt-4">
                        <form action="/scan" method="post" id="scan-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-primary btn-scan" id="scan-button">
                                <i class="fas fa-radar me-2"></i>Scan Network
                            </button>
                        </form>
                        
                        <!-- Scan Progress Indicator (hidden by default) -->
                        <div id="scan-progress-container" class="mt-3 d-none">
                            <div class="scan-status-box">
                                <div class="scan-animation">
                                    <i class="fas fa-wifi scan-pulse"></i>
                                </div>
                                <h4 id="scan-status-message">Scanning network...</h4>
                                <div id="scan-phases" class="scan-phases">
                                    <div id="phase-init" class="scan-phase"><i class="fas fa-spinner fa-spin me-2"></i>Initializing scanner</div>
                                    <div id="phase-detect" class="scan-phase"><i class="fas fa-search me-2"></i>Detecting devices</div>
                                    <div id="phase-analyze" class="scan-phase"><i class="fas fa-sitemap me-2"></i>Analyzing connections</div>
                                    <div id="phase-complete" class="scan-phase"><i class="fas fa-check-circle me-2"></i>Completing scan</div>
                                </div>
                                <p id="scan-devices-found" class="mt-2 mb-0 d-none"><strong>Devices found: <span id="devices-count">0</span></strong></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card activity-card">
                <div class="card-header">
                    <div class="header-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h5>Activity Summary</h5>
                </div>
                <div class="card-body">
                    <div class="activity-stats">
                        <div class="stat-item">
                            <div class="stat-icon"><i class="fas fa-search-location"></i></div>
                            <div class="stat-details">
                                <div class="stat-value">{{ total_scans }}</div>
                                <div class="stat-label">Total Scans</div>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon {% if alerts_24h > 0 %}alert-icon{% endif %}">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-value {% if alerts_24h > 0 %}text-danger{% endif %}">{{ alerts_24h }}</div>
                                <div class="stat-label">Alerts (24h)</div>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon {% if alerts_7d > 0 %}alert-icon{% endif %}">
                                <i class="fas fa-calendar-exclamation"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-value {% if alerts_7d > 0 %}text-danger{% endif %}">{{ alerts_7d }}</div>
                                <div class="stat-label">Alerts (7d)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="security-notice">
                        <div class="notice-icon"><i class="fas fa-shield-check"></i></div>
                        <div class="notice-text">
                            This tool is for ethical use only. Do not scan networks you don't own or have permission to scan.
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-card trusted-devices-card">
            <div class="card-header">
                <div class="header-icon">
                    <i class="fas fa-shield-check"></i>
                </div>
                <h5>Trusted Devices</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped devices-table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>MAC Address</th>
                                <th>Added On</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for device in trusted_devices %}
                            <tr>
                                <td>
                                    <div class="device-name">
                                        <div class="device-icon device-trusted">
                                            <i class="fas fa-laptop-house"></i>
                                        </div>
                                        {{ device.name }}
                                    </div>
                                </td>
                                <td><code>{{ device.mac }}</code></td>
                                <td>{{ device.added_on }}</td>
                                <td>
                                    <form action="/untrust" method="post" class="d-inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="mac" value="{{ device.mac }}">
                                        <button type="submit" class="btn btn-sm btn-warning rounded-pill">
                                            <i class="fas fa-shield-xmark me-1"></i>Untrust
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Add device form removed as devices are now auto-trusted -->
            </div>
        </div>

        <div class="dashboard-card logs-card">
            <div class="card-header">
                <div class="header-icon">
                    <i class="fas fa-history"></i>
                </div>
                <h5>Recent Scan Logs</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped devices-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Total Devices</th>
                                <th>Untrusted Devices</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in recent_logs %}
                            <tr>
                                <td>
                                    <div class="log-timestamp">
                                        <i class="fas fa-calendar-day me-2"></i>
                                        {{ log.timestamp }}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-primary rounded-pill">
                                        <i class="fas fa-devices me-1"></i>
                                        {{ log.device_count }}
                                    </span>
                                </td>
                                <td>
                                    {% if log.untrusted_count > 0 %}
                                        <span class="badge bg-danger rounded-pill">
                                            <i class="fas fa-shield-exclamation me-1"></i>
                                            {{ log.untrusted_count }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success rounded-pill">
                                            <i class="fas fa-shield-check me-1"></i>
                                            0
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-info rounded-pill" data-bs-toggle="modal" data-bs-target="#logModal{{ loop.index }}">
                                        <i class="fas fa-search me-1"></i>View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Detail Modals -->
    {% for log in recent_logs %}
    <div class="modal fade" id="logModal{{ loop.index }}" tabindex="-1" aria-labelledby="logModalLabel{{ loop.index }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title-wrapper">
                        <div class="modal-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <h5 class="modal-title" id="logModalLabel{{ loop.index }}">Scan Log - {{ log.timestamp }}</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="log-summary mb-4">
                        <div class="log-stat">
                            <div class="stat-icon">
                                <i class="fas fa-devices"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">{{ log.device_count }}</div>
                                <div class="stat-label">Total Devices</div>
                            </div>
                        </div>
                        <div class="log-stat">
                            <div class="stat-icon {% if log.untrusted_count > 0 %}stat-danger{% else %}stat-success{% endif %}">
                                <i class="fas fa-{% if log.untrusted_count > 0 %}shield-exclamation{% else %}shield-check{% endif %}"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value {% if log.untrusted_count > 0 %}text-danger{% else %}text-success{% endif %}">{{ log.untrusted_count }}</div>
                                <div class="stat-label">Untrusted Devices</div>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mb-3">Detected Devices</h6>
                    <div class="table-responsive">
                        <table class="table table-striped devices-table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Device</th>
                                    <th>IP Address</th>
                                    <th>MAC Address</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in log.devices %}
                                <tr>
                                    <td>
                                        <span class="badge {% if device.trusted %}bg-success{% else %}bg-danger{% endif %} rounded-pill">
                                            {% if device.trusted %}
                                                <i class="fas fa-shield-check me-1"></i>Trusted
                                            {% else %}
                                                <i class="fas fa-shield-exclamation me-1"></i>Untrusted
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="device-name">
                                            <div class="device-icon {% if device.trusted %}device-trusted{% else %}device-untrusted{% endif %}">
                                                <i class="fas fa-{% if 'phone' in device.name|lower %}mobile{% elif 'tv' in device.name|lower %}tv{% elif 'tablet' in device.name|lower %}tablet{% elif 'laptop' in device.name|lower %}laptop{% else %}desktop{% endif %}"></i>
                                            </div>
                                            {{ device.name if device.name else device.hostname }}
                                        </div>
                                    </td>
                                    <td>{{ device.ip }}</td>
                                    <td><code>{{ device.mac }}</code></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <footer class="bg-light py-3 mt-5">
        <div class="container text-center">
            <p class="mb-0">Wi-Fi Device Tracker &copy; 2025 | <a href="https://github.com/yourusername/wifi-device-tracker" target="_blank">GitHub</a></p>
            <p class="text-muted small mb-0">For ethical use only. Do not scan networks without permission.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Theme toggle functionality
            const themeToggle = document.getElementById('theme-toggle');
            const htmlElement = document.documentElement;
            
            // Check for saved theme preference or use default (light)
            const savedTheme = localStorage.getItem('theme') || 'light';
            htmlElement.setAttribute('data-theme', savedTheme);
            
            // Update button icon based on current theme
            updateThemeIcon(savedTheme);
            
            // Toggle theme when button is clicked
            themeToggle.addEventListener('click', function() {
                const currentTheme = htmlElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                
                // Apply the new theme
                htmlElement.setAttribute('data-theme', newTheme);
                
                // Save the theme preference
                localStorage.setItem('theme', newTheme);
                
                // Update button icon
                updateThemeIcon(newTheme);
            });
            
            // Function to update the theme toggle icon
            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    document.querySelector('.fa-sun').style.opacity = '1';
                    document.querySelector('.fa-sun').style.transform = 'rotate(0deg)';
                    document.querySelector('.fa-moon').style.opacity = '0';
                    document.querySelector('.fa-moon').style.transform = 'rotate(100deg)';
                } else {
                    document.querySelector('.fa-sun').style.opacity = '0';
                    document.querySelector('.fa-sun').style.transform = 'rotate(-100deg)';
                    document.querySelector('.fa-moon').style.opacity = '1';
                    document.querySelector('.fa-moon').style.transform = 'rotate(0deg)';
                }
            }
            
            const scanForm = document.getElementById('scan-form');
            const scanButton = document.getElementById('scan-button');
            const progressContainer = document.getElementById('scan-progress-container');
            const progressBar = document.getElementById('scan-progress-bar');
            const statusMessage = document.getElementById('scan-status-message');
            const devicesFoundContainer = document.getElementById('scan-devices-found');
            const devicesCount = document.getElementById('devices-count');
            
            let scanInterval = null;
            
            // Handle scan form submission
            scanForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Prevent default form submission
                
                // Submit the form via AJAX
                fetch('/scan', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams(new FormData(scanForm))
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'started') {
                        // Start polling for updates
                        startProgressPolling();
                    } else if (data.status === 'in_progress') {
                        // Show alert that scan is already in progress
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-info alert-dismissible fade show';
                        alertDiv.innerHTML = `
                            <i class="fas fa-info-circle me-2"></i>
                            A scan is already in progress!
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
                        
                        // Also start polling to show the current progress
                        startProgressPolling();
                    }
                })
                .catch(error => {
                    console.error('Error starting scan:', error);
                    // Show error message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error starting scan. Please try again.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
                });
            });
            
            function startProgressPolling() {
                // Show progress container
                progressContainer.classList.remove('d-none');
                scanButton.disabled = true;
                
                // Get references to phase elements
                const phaseInit = document.getElementById('phase-init');
                const phaseDetect = document.getElementById('phase-detect');
                const phaseAnalyze = document.getElementById('phase-analyze');
                const phaseComplete = document.getElementById('phase-complete');
                
                // Reset all phases
                document.querySelectorAll('.scan-phase').forEach(phase => {
                    phase.classList.remove('active', 'completed');
                });
                
                // Clear any existing intervals
                if (scanInterval) {
                    clearInterval(scanInterval);
                }
                
                // Start with the first phase active
                phaseInit.classList.add('active');
                phaseInit.querySelector('i').classList.add('fa-spin');
                
                // Poll for scan status more frequently (250ms)
                scanInterval = setInterval(checkScanStatus, 250);
                
                // Immediate check to show current status
                checkScanStatus();
            }
            
            // Track the current scan phase
            let currentPhase = 0;
            const phases = ['init', 'detect', 'analyze', 'complete'];
            
            function updateScanPhase(progress) {
                // Determine which phase we should be in based on progress
                let newPhase;
                if (progress < 30) newPhase = 0;
                else if (progress < 60) newPhase = 1;
                else if (progress < 90) newPhase = 2;
                else newPhase = 3;
                
                // If we've moved to a new phase
                if (newPhase > currentPhase) {
                    // Complete previous phases
                    for (let i = 0; i <= currentPhase; i++) {
                        const phaseElement = document.getElementById(`phase-${phases[i]}`);
                        phaseElement.classList.remove('active');
                        phaseElement.classList.add('completed');
                        phaseElement.querySelector('i').classList.remove('fa-spin', 'fa-circle-notch');
                        phaseElement.querySelector('i').classList.add('fa-check-circle');
                    }
                    
                    // Activate new phase
                    const newPhaseElement = document.getElementById(`phase-${phases[newPhase]}`);
                    newPhaseElement.classList.add('active');
                    newPhaseElement.querySelector('i').classList.add('fa-spin');
                    
                    // Update current phase
                    currentPhase = newPhase;
                }
            }
            
            // Track consecutive identical progress values to detect stuck scans
            let lastProgress = 0;
            let stuckCounter = 0;
            let maxStuckCount = 10; // After this many identical progress values, consider scan stuck
            
            function checkScanStatus() {
                fetch('/scan_status')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Scan status:', data);
                        
                        // Check if scan is stuck at the same progress
                        if (data.progress === lastProgress && data.is_scanning) {
                            stuckCounter++;
                            console.log(`Progress stuck at ${data.progress}% for ${stuckCounter} checks`);
                            
                            // If stuck for too long, force refresh
                            if (stuckCounter >= maxStuckCount) {
                                console.log('Scan appears stuck, forcing refresh');
                                window.location.reload();
                                return;
                            }
                        } else {
                            // Reset counter if progress changed
                            stuckCounter = 0;
                            lastProgress = data.progress;
                        }
                        
                        // Update the scan phase based on progress
                        updateScanPhase(data.progress);
                        
                        // Update status message if provided
                        if (data.status_message) {
                            statusMessage.textContent = data.status_message;
                        }
                        
                        // Update devices found count if available
                        if (data.devices_found !== undefined && data.devices_found > 0) {
                            devicesFoundContainer.classList.remove('d-none');
                            devicesCount.textContent = data.devices_found;
                        }
                        
                        // If scan is complete, stop polling and refresh the page after a delay
                        if (!data.is_scanning && data.progress >= 100) {
                            clearInterval(scanInterval);
                            scanInterval = null;
                            
                            // Complete all phases
                            phases.forEach((phase, index) => {
                                const phaseElement = document.getElementById(`phase-${phase}`);
                                phaseElement.classList.remove('active');
                                phaseElement.classList.add('completed');
                                phaseElement.querySelector('i').classList.remove('fa-spin', 'fa-circle-notch');
                                phaseElement.querySelector('i').classList.add('fa-check-circle');
                            });
                            
                            // Update status message
                            statusMessage.textContent = 'Scan complete!';
                            
                            // Show the results without refreshing
                            scanButton.disabled = false;
                            
                            // Hide the scan progress container
                            document.getElementById('scan-progress-container').classList.add('d-none');
                            
                            // Add a success message
                            const successAlert = document.createElement('div');
                            successAlert.className = 'alert alert-success mt-3';
                            successAlert.innerHTML = `
                                <i class="fas fa-check-circle me-2"></i>
                                Scan complete! <a href="#" onclick="window.location.reload(); return false;">Refresh</a> to see results.
                            `;
                            document.getElementById('scan-controls').appendChild(successAlert);
                        }
                        
                        // If scan is no longer in progress but not at 100%
                        if (!data.is_scanning && data.progress < 100) {
                            clearInterval(scanInterval);
                            scanInterval = null;
                            scanButton.disabled = false;
                            
                            // Show error if progress isn't 100%
                            statusMessage.textContent = 'Scan failed or was interrupted. Please try again.';
                            document.querySelectorAll('.scan-phase').forEach(phase => {
                                phase.classList.remove('active', 'completed');
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error checking scan status:', error);
                        clearInterval(scanInterval);
                        scanInterval = null;
                        statusMessage.textContent = 'Error checking scan status. Please try again.';
                        scanButton.disabled = false;
                    });
            }
            
            // Check if a scan is already in progress when the page loads
            fetch('/scan_status')
                .then(response => response.json())
                .then(data => {
                    if (data.is_scanning) {
                        // If a scan is in progress, start the polling
                        startProgressPolling();
                    } else {
                        // Make sure scan status is reset if a previous scan was completed
                        scanButton.disabled = false;
                        document.getElementById('scan-progress-container').classList.add('d-none');
                    }
                })
                .catch(error => {
                    console.error('Error checking initial scan status:', error);
                });
        });
    </script>
</body>
</html>
